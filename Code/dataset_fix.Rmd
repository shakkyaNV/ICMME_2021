---
title: "ICMME - Merge_initial_Dataset fix"
author: "eNVy"
date: "`r Sys.Date()`"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, comment = NULL)
# knitr::opts_chunk$set(warning = F, message = F) # Un-comment at the end
```

```{r libs, include = F}
library(tidyverse)
library(magrittr)
```

# Dataset import RAW

```{r import, warning=F, message=F}
raw_df <- read_csv("../Data/heavy/merge_initial.csv", 
                   col_names = T,
                   col_types = cols(Code = "c", award = "f", 
                                    .default = col_double()), 
                   )
raw_df %>% head()

```

# Indicator dfs
```{r import, warning=F, message=F}
ind_list <- list.files(path = "../Data/heavy/", 
                                pattern = "*indicator.csv", 
                                full.names = T)
indicator_nested_tbl <- map(ind_list, read_csv)

indicator_temp_names <- ind_list %>% 
  str_remove(pattern = "../Data/heavy/") %>% 
  str_remove(pattern = ".csv")

for (i in 1:length(indicator_temp_names)) {
  assign(indicator_temp_names[i], indicator_nested_tbl[[i]])
}
```

# Remove possible indicators

```{r}
temp <- raw_df %>% sample_n(5) %>% t() %>% data.frame() %>% 
  rownames_to_column(var = "INDICATOR_CODE")

temp %>% left_join(y = API_8_indicator, 
                   by = 'INDICATOR_CODE')  %>% 
  select(c(1,7)) %>% View()

# possible remove indices are in to be removed.txt
```


# Fix dataset

To do within data set
  
  + Fix NA
    + Count NA
      + By country
      + By year
      + By index
      
    + Removed before
      + A --> If all NA for every index for given country_index (All years) (NA Horz) -- Remove country_index
      + B --> If all NA for every country_index for given index             (NA Vert) -- Remove index
      + C --> If all NA for every year for a given country for a given index (NA Vert, 1984 - 2017) -- Remove country
      
    + Fix how?
      + A --> Check the y data set in ```left merge``` for **country_names** conflicts
      + B --> No solution
      + C --> Can replace value by other related category mean (eg. SP.POP.5054.MA.5Y NA replaced by SA.POP category in same years/country_index )
      
    + Replace NA
      + prev by mean() 
      + try linear approx()
      + Time series ar() approx()
      
  + New indices
    + Add vars by down sampling for consistency
    + possible new indices
      + Coffee index


# Find which countries have less information (Type A)

```{r}
raw_df %>% 
  mutate(
    rowSumNA = rowSums(is.na(raw_df))
  ) %>% group_by(Year, Code) %>% select(Year, Code, rowSumNA) %>% 
  arrange(Code, Year, rowSumNA) %>% unique() # %>% View()

# 245 after removing incidec from to_be_removed.txt and prop > 0.8

raw_df %>% filter(Code == "ALG")
```

# Count and proportion of NA by variable (Type B)

```{r}
# test <- raw_df %>% head(40) %>% select(1:10)
temp2 <- raw_df %>% summarise(
  across(everything(), ~sum(is.na(.x)))
) %>% t() %>% data.frame()

temp2 %<>%  rownames_to_column()

temp2 %>% mutate(
  prop = ./(dim(raw_df)[1])
) %>% arrange(desc(prop))#  -> temp3 # %>% View()
```


# NA count for each index grouped by Year

```{r}
what <- (raw_df %>% 
           group_by(Code) %>% 
           summarise(Count = n())) %>% 
  select(Code, Count)

temp4 <- raw_df %>% # select(c(1,2,4:10)) %>% 
  # filter(Code == "GDR" | Code == "USS") %>% 
  group_by(Code) %>% 
  summarise(
    across(everything(), ~sum(is.na(.x)))
  ) %>% 
  select(-c(Year, award)) %>% arrange(Code) 

temp5 <- bind_cols(what, temp4)
View(temp5)

# temp5

# remove years with matching Counts and NAs
```


```{r}
# make a copy of raw_df before proceeding
raw_df -> raw_df_copy
```

# Remove selected ```indices``` and ```Codes```

## Remove indices pre identified via manual search of indices

```{r}
# from tobe_removed.txt
to_be_removed <- c(18:21, 23,25, 39, 41, 43,65, 67, 69, 77, 79, 81, 111, 115,116, 118,119, 121:124, 126,127, 129,130, 135, 137, 139, 141, 140, 144,145, 146, 178, 206, 221, 271, 281, 284, 286, 288, 314, 315, 329:331, 335, 342, 340, 367, 398, 426)

raw_df %<>% select(-all_of(to_be_removed))
```

resulting dim() = 14835 372
rerun above codes to see diff.

## Remove indices with more than `r upper_bound_prop` empty prop

```{r}
upper_bound_prop = 0.8

temp3 %>% filter(prop > upper_bound_prop) %>% 
  pull(var = rowname) %>% 
  as.vector() -> var_indiceRemove_tooManyNA 

raw_df %<>% select(-any_of(var_indiceRemove_tooManyNA))
# check and remove necessary
```

```{r}
raw_df %>% dim()
```


# Find a possible year range for all indices

```{r}
raw_df %>% 
  group_by(Code) %>% 
  summarise(min = min(Year), 
            max = max(Year))

# find a possible lower bound that's good (possible future approx()) for most of the countries
raw_df %>% select(Code) %>% unique() %>% count()
```



